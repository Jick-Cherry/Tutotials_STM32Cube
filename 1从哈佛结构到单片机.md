### 从哈佛结构到单片机

这是一个面向刚刚接触STM32单片机的大一大二小白同学的教程，在这一阶段，许多同学还没有学过模拟电路、数字电路、单片机原理或微机原理等科目，但因为参加竞赛的原因，需要学习单片机知识。因此，我们希望用这个视频帮助大家简单了解一下单片机的原理，帮助大家更加容易的学习STM32的使用，进而在竞赛或课程中取得更优异的成绩。

这个视频的主要内容如下，需要的同学可以自行跳转

（屏幕显示目录）

#### **1. 何为单片机**

首先，我们先得知道什么是单片机

单片机，也即Single Chip Microcomputer，从这个名字上看，它是一台浓缩到一个芯片的微型电脑，很多同学会把MCU和CPU弄混，实际在不考虑性能，仅考虑功能特点的情况下，MCU中也有适合自己能力的CPU，可以称得上是麻雀虽小，五脏俱全。

我们也把它叫做MCU，也即Microcontroller Unit——微控制单元。

单片机有很多不同的类型，比较著名的有ST公司生产的STM32系列单片机，本次我们以它为例进行介绍、Atmel公司生产的AVR单片机，这是著名的Arduino开发板的核心芯片、国内公司乐鑫科技的ESP32、还有许多著名的芯片厂商如恩智浦(NXP)、德州仪器(TI)、微芯(Microchip)等也都有各自的单片机产品。

通常情况下，为了方便自己学习单片机，我们会选择购买与网络教程相配套的单片机开发板，例如正点原子、野火等品牌，这里不一一列举，但实际上，我们所指的单片机，只有这片黑乎乎的芯片。

#### **2. 单片机的结构与组成**

在大学计算机或计算思维课程中，我们学过计算机的结构，由冯·诺伊曼提出的冯·诺伊曼结构成为了当下通用电脑、手机等高性能计算机的基本结构，而另一种结构——哈佛结构则成为了MCU的骨架。（下图需要重绘）

![哈佛结构和冯诺依曼结构](https://picx.zhimg.com/v2-3333594d99b4c825d99737d7d771b99c_720w.jpg?source=172ae18b)

相较于冯·诺伊曼结构，哈佛结构最大的区别在于将数据和程序指令单独分开存储，使得控制器能够通过两条总线同时访问程序存储器和数据存储器，执行时可以预先读取下一条指令。这一设计提高了控制器的访问效率，降低了出错概率，提升了MCU的运行效率和稳定性。

在哈佛结构中，计算机由以下基本单元构成：控制器、运算器、程序存储器、数据存储器和输入输出接口

##### 1. 运算器

首先计算机要有运算处理数据的能力，所以需要一个处理单元来完成各种算数运算和逻辑运算，这就是算术逻辑单元（Arithmetic Logic Unit，ALU）。ALU的主要功能就是在控制信号的作用下，完成加、减、乘、除等算术运算以及与、或、非、异或等逻辑运算以及移位、补位等运算。

运算器与其他部分的关系：

计算机运算时，运算器的操作对象和操作种类由控制器决定。运算器操作的数据从内存中读取，处理的结果再写入内存（或者暂时存放在内部寄存器中），而且运算器对内存数据的读写是由控制器来进行的。

##### 2. 控制器

控制单元（Control Unit）是计算机的神经中枢和指挥中心，只有在控制器的控制下，计算机才能够有条不紊地工作、自动执行程序。

控制器的工作流程为：从内存中取指令、翻译指令、分析指令，然后根据指令的内存向有关部件发送控制命令，控制相关部件执行指令所包含的操作。

控制器和运算器共同组成中央处理器（Central Processing Unit），CPU是一块超大规模集成电路，是计算机运算核心和控制核心，CPU的主要功能是解释计算机指令以及处理数据。

##### **3.存储器**

存储器的主要功能是存储程序和各种数据，并且能够在计算机运行过程高速、自动地完成程序或者数据的存储，存储器是有记忆的设备，而且**采用两种稳定状态的物理器件来记录存储信息，所以计算机中的程序和数据都要转换为二进制代码才可以存储和操作。**存储器中这种能够保持在两种稳定状态以存储一位二进制数的结构就被称为寄存器，一些特殊功能的寄存器对应的是MCU的功能器件的运行状态，因此我们可以通过改写这些特殊功能寄存器(Special Function Register, SFR)来改变它们的运行状态，这就是基于寄存器的开发。

存储器可以分为内部存储器（内存）和外部存储器，二者在计算机系统中各有用处，下面大概介绍一下两种存储器的特点：

###### **Ⅰ.内部存储器**

内部存储器称为内存或者主存，是用来存放将要执行的程序和数据。

在计算机内部，程序和数据都是以二进制代码的形式存储的，它们均以字节为单位（8位）存储在存储器中，一个字节占用一个存储单元，并且每个存储单元都有唯一的地址号。

> 这里以字节（8位）为存储单元，就与运算器的操作数据的大小联系起来了，16、32、64都是8的倍数

CPU可以直接使用指令对内部存储器按照地址进行读写俩种操作，读：将内存中某个存储单元的内容读出，送入CPU的某个寄存器中；写：在控制器的控制下，将CPU中某寄存器内容传到某个存储单元中。

要注意，内存中的数据和地址码都是二进制数，但是俩者是不同的，一个地址可以指向一个存储单元，地址是存储单元的位置，数据是存储单元的内容，数据可以是操作码、可以是CPU要处理的数据、也可以是数据的地址，地址码的长度由内存单元的个数确定。

内存的存取速度会直接影响计算机的运算速度，由于CPU是高速器件，CPU的速度是受制于内存的存取速度的，所以为了解决CPU和内存速度不匹配的问题，在CPU和内存之间设置了一种高速缓冲存储器Cache。 Cache是计算机中的一个高速小容量存储器，其中存放的是CPU近期要执行的指令和数据，其存取速度可以和CPU的速度匹配，一般采用静态RAM(SRAM)充当Cache

内存按工作方式的不同又可以分为俩部分：

RAM：随机存储器，可以被CPU随机读取，一般存放CPU将要执行的程序、数据，断电丢失数据

ROM：只读存储器，只能被CPU读，不能轻易被CPU写，用来存放永久性的程序和数据，比如：系统引导程序、监控程序等。具有掉电非易失性。

###### **Ⅱ.外部存储器**

外部存储器主要来存放”暂时“用不着的程序和数据，可以和内存交换数据。

##### 4. 输入输出接口（I/O接口）

我们操作计算机时，都是与输入输出设备在打交道。比如鼠标键盘、显示器、手机触摸屏、服务器中网卡；

但单片机的接口就是如图中的这些引脚，通常我们将单片机安装或焊接在PCB，印刷电路板上，以便将这一引脚引出，再通过各种接口或者杜邦线连接到输入输出设备上，通过特定的通信协议传输数据来驱动输入输出设备。