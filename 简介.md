## 绪论
本系列教程编写的初衷是帮助从标准库入手的同学，尽快适应HAL库的编写逻辑，能够熟练的使用HAL库进行基础功能的使用和代码的编写。而对于初步接触到HAL库的同学，我们希望这系列的教程能够帮助大家轻松上手基于cubeMX的HAL库stm32编程，在对底层原理没有足够理解的情况下，也能编写出一些基础甚至有趣的代码，不至于在繁杂的基础原理学习中，慢慢丧失了学习的动力。
由于本系列教程的初始目标受众是南京理工大学Alliance战队电控组成员，所以大多数的配置都是基于大疆C板，但是我们也会尽量描述将其背后通用的思想和原理，同时会对战队的常用代码逻辑进行剖析。
本系列教程主要分成两个部分：CubeMX初始化配置系列教程、战队常用代码讲解。

## 如何使用CubeMX、HAL库进行配置
虽然CubeMX对于新手来说，图形化的配置界面已经友好了很多，但如果是对stm32单片机功能一点都不懂的同学，看到其中那么多的专业名词、各种各样的参数配置选项，难免会像刘姥姥进大观园一样无所适从。因此，想要配置好CubeMX、使用好HAL库，首先要有一套自己的方法论，知道一旦出了问题应该去查阅什么资料。
对于一个开发板来说，最基本的资料文档有三个方面：开发板的介绍文档、开发板使用芯片的芯片手册、开发板的硬件原理图（有可能会不开源）。以大疆的C板举例子， 开发板的介绍资料是大疆的《RoboMaster开发板C型用户手册》和《RoboMaster开发板C型使用说明》，这里面介绍了开发板的性能，并且结合部分原理图上的内容，大致从应用层面介绍了板子上各个接口的用途、参数、线序和对应单片机的引脚口。开发板的芯片手册在ST官网上可以下载，文件的DocID为022152，里面非常详细的说明了芯片可以实现什么功能，对应的指标和引脚是什么。开发板的硬件原理图是《RoboMaster开发板C型原理图&位号图》，里面详细表示了大疆是怎么基于这一芯片设计这一款单片机的。除此之外，《STM32F4xx中文参考手册》也是我们常用的选择。
对于CubeMX的图形化界面的使用，我们一般会选择在CSDN上查看别人的教程，跟着前辈的步伐去试着配置出自己想要的功能。当然，ST官方也有对应的CubeMX+HAL库的使用教程和视频，但是总体来说，并没有做到面面俱到，因此直接在网络上搜索可能会更方便一些。
那在编写代码的时候，我们应该怎么选择到合适的HAL库函数呢？一般来说可以通过查看stm32f4xx_hal_xxx.c格式的文件中的开头注释How to use this driver的部分来明晰自己可能需要使用的函数，但事实上这部分注释也难以完美地实现配置操作，更多的还是应该参考CSDN上其他人的配置过程或者按照我们后续的教程进行配置。直接从头文件中查看对应的函数、宏定义和结构体也是一种不错的办法。
除此之外，我们遇到一些不太了解的功能时，其实可以很好地利用正点原子系列教程或者视频的培训内容，通过他的培训资料，初步了解单片机的这些外设都有什么用处、一般都有什么功能和参数，再在这个的基础上尝试配置出自己的功能。对于stm32f4xxxxxx类型芯片的单片机，《STM32F4xx中文参考手册》也是一份很常用的参考资料，相比于芯片的datasheet，它的内容并没有很大程度上的不同，但是纯中文的表述，对于英语不太好的入门者来说，友好了很多，当然如果可以的话，还是提高下自己的英文阅读能力吧。
总结：我们建议的学习方式是，在配置某外设、功能的时候，先通过正点原子或野火了解下该外设功能的大致原理，接着按照本系列教程和大疆C板教程，在大疆C板实验例程的基础上，做一些修改，验证自己对本外设功能的了解程度。在这过程中，有不理解的地方，再去查找以上提到的资料。
## 常用的查找资料思路
时钟树的配置思路，尤其是不同功能的外设挂接在哪一条时钟总线上。可以参考《STM32F4xx中文参考手册》的2.3存储器映射
![](https://carrot-1306907789.cos.ap-nanjing.myqcloud.com/pictures/20221120001543.png)
或者是芯片Datasheet的STM32F40xxx block diagram
![](https://carrot-1306907789.cos.ap-nanjing.myqcloud.com/pictures/20221120005748.png)
对于查询单片机某个外设接口对应的是哪个芯片引脚
一种方法是直接看单片机的介绍中有没有对应的内容，比如大疆的《RoboMaster开发板C型用户手册》和《RoboMaster开发板C型使用说明》，另一种方法是通过查询开发板的硬件原理图，根据原理图上的连线得知接口对应的芯片引脚，不过这种方法需要有一些基础的原理图读图能力。
在配置CubeMX的图形化界面时，有时候会发现有很多的选项可以选择，并且由于自己知识的局限性，并不知道这些选项应该怎么配置才比较合适，或者说不知道这些选项应不应该配置。根据我自己的实操经验来说，先大致浏览下正点原子的教程，看看自己疑惑的选项可能是个什么东西，同时在网络上搜索下这个外设功能大家是怎么配置的，如果正点原子和网络上的资料都没有提及那个让你感到疑惑的选项设置，那一般来说保持默认就可以了，等到它真正出现问题后，再去查询芯片datasheet等比较详细的资料，着重看它在寄存器层面是怎么配置、变化的。虽然我这种说法看上去很不负责任，但是对于才接触到单片机的同学来说，先动手试试可能是更重要的步骤，而从寄存器层面去吃透单片机，是一个费时费力并且不是很有必要的事情；但是最好在单片机学习有所小成、沾沾自喜的时候，提醒下自己：你还不具备寄存器层面的调试能力，你未来学习的路还长着呢。
如何通过HAL库官方（文件名称类似于：stm32f4xx_hall_gpio）的文件注释，找到自己需要的资源。
HAL库官方的源文件一般可以用来查阅函数详细的注释说明，知道这个函数具体的作用是什么、它的输入参数是什么、输出参数是什么、有哪几个可以配置的选项，或者根据How to use this driver来配置基础的代码功能。
![](https://carrot-1306907789.cos.ap-nanjing.myqcloud.com/pictures/20221120013628.png)
以上为官方设定的HAL_SPI_Transmit函数的介绍，brief、param、retval分别介绍了这个函数的基本功能、应该输入什么样的参数、这个函数运行结束后会返回什么类型的数据。
HAL库的官方头文件就有点像一个集市，一眼望过去，琳琅满目，什么宏定义、结构体、函数声明……应有尽有，我们可以在其中随意挑选自己的喜欢的内容，但是至于这个内容是不是真的适合我们的功能、应该怎样配置，这个还需要你去慢慢观察。
![](https://carrot-1306907789.cos.ap-nanjing.myqcloud.com/pictures/20221120014103.png)
头文件中最先出现的是定义的结构体和枚举变量，例如上图中的type struct 和typedef enum，不要小瞧这些内容，它们往往是HAL库函数传递的数据的主要表现形式。虽然从本质上来说，它们不过是一些常数或者常见数据类型的变量，但是，通过这种包装的方式，可以大大增加代码的可读性。不过代价嘛，就是你在敲代码的时候，最好也要遵循它的这个略显繁琐的要求，但是相信我，你在未来时隔很久，阅读这一份代码的时候，你会感谢当时的自己。
![](https://carrot-1306907789.cos.ap-nanjing.myqcloud.com/pictures/20221120121704.png)
宏定义也是常用来表示外设功能配置或者执行状态的方式，易于阅读和理解。
![](https://carrot-1306907789.cos.ap-nanjing.myqcloud.com/pictures/20221120122012.png)
这种表述样式的函数声明，一般是我们在配置的过程中最先考虑的部分，里面都是些我们最常用的函数
![](https://carrot-1306907789.cos.ap-nanjing.myqcloud.com/pictures/20221120122831.png)
这种类型的宏定义，一般是起辅助作用，当我们需要使用外设的某些特殊功能或者需要知道外设的某个内部寄存器参数的时候，就要使用这部分的宏定义来做到私人定制了。

## HAL库主要文件构成
![](https://carrot-1306907789.cos.ap-nanjing.myqcloud.com/pictures/20221120133413.png)
CubeMX生成的HAL库文件一般呈现为类似的架构，其中我们主要关注的是Appliaction/User/Core下的文件，main.c负责整个项目代码逻辑的运行，大致的初始化函数CubeMX已经生成。gpio.c/tim.c之类的文件，里面包含了CubeMX根据我们在图形化界面中的配置选择，自动生成的初始化配置代码，如果我们的项目不是很复杂，也可以将我们需要的自定义的一些函数逻辑，放在这些文件里。stm32f4xx_it.c文件是负责整个项目的中断管理部分，我们可以在其中配置我们需要的中断后的处理逻辑。stm32f4xx_hal_msp.c文件一般不需要进行修改，主要涉及时钟等的初始化。
Application/MDK-ARM和Drivers/CMSIS文件下的内容保持默认就可以，主要涉及程序的启动文件和底层配置。
Drivers/STM32F4xx_HAL_Driver文件下的内容也不需要修改，里面主要是CubeMX配置好的一些封装好的功能，我们只要学会调用就可以了。
此外在我们使用KEIL编写代码的时候，记得要把所有自己的代码放在user code begin 和user code end之间，不然在下次从CubeMX更新代码的时候，会被系统自动删除。